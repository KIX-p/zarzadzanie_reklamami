{% extends 'base.html' %}
{% load static %}

{% block title %}Materiały Reklamowe - {{ stand.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css">
<style>
    .material-card {
        cursor: grab;
        margin-bottom: 15px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .material-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .material-card.ui-sortable-helper {
        cursor: grabbing;
        transform: rotate(2deg) scale(1.02);
        box-shadow: 0 15px 25px rgba(0,0,0,0.15);
    }
    .material-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.8);
        border-radius: 4px;
        padding: 5px;
    }
    .material-preview {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: #f8f9fa;
    }
    .material-preview img {
        max-height: 100%;
        max-width: 100%;
    }
    .material-preview video {
        max-height: 100%;
        max-width: 100%;
    }
    .status-badge {
        position: absolute;
        top: 10px;
        left: 10px;
    }
    #sortable-container {
        min-height: 200px;
    }
    .empty-message {
        padding: 30px;
        text-align: center;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        color: #6c757d;
    }
    .order-number {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background-color: rgba(0,0,0,0.7);
        color: white;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    .material-card.ui-sortable-placeholder {
        border: 3px dashed #dee2e6;
        background-color: #f8f9fa;
        visibility: visible !important;
        height: 200px;
        opacity: 0.5;
    }
    .drop-indicator {
        display: none;
        padding: 20px;
        text-align: center;
        border: 3px dashed #28a745;
        border-radius: 8px;
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
        margin: 10px 0;
    }
    .drop-active .drop-indicator {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">{{ stand.department.store.name }}</li>
                    <li class="breadcrumb-item">{{ stand.department.name }}</li>
                    <li class="breadcrumb-item active">{{ stand.name }}</li>
                </ol>
            </nav>
            <h2>Materiały reklamowe - {{ stand.name }}</h2>
        </div>
        <div class="col-auto">
            <a href="{% url 'material-create' stand_id=stand.id %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Dodaj materiał
            </a>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i> Informacje o stoisku
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Sklep:</strong> {{ stand.department.store.name }}</p>
                    <p><strong>Dział:</strong> {{ stand.department.name }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Nazwa stoiska:</strong> {{ stand.name }}</p>
                    <p><strong>Czas wyświetlania:</strong> {{ stand.display_time }} sekund</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Animacja przejścia:</strong> {{ stand.get_transition_animation_display }}</p>
                    <p><strong>Liczba materiałów:</strong> {{ materials|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-images me-2"></i> Materiały (przeciągnij, aby zmienić kolejność)
            </h5>
        </div>
        <div class="card-body">
            <div id="sortable-container">
                {% if materials %}
                    <div class="row" id="sortable">
                        {% for material in materials %}
                            <div class="col-lg-4 col-md-6 mb-4" data-id="{{ material.id }}">
                                <div class="card material-card position-relative">
                                    <div class="material-preview">
                                        {% if material.material_type == 'image' %}
                                            <img src="{{ material.file.url }}" alt="Materiał #{{ material.id }}">
                                        {% else %}
                                            <video src="{{ material.file.url }}" controls></video>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                        <h6>{{ material.get_material_type_display }}</h6>
                                        <p class="mb-1">Czas wyświetlania: {{ material.duration }} s</p>
                                        <small class="text-muted">Dodano: {{ material.created_at|date:"d.m.Y H:i" }}</small>
                                    </div>
                                    <div class="material-actions">
                                        <a href="{% url 'material-update' pk=material.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'material-delete' pk=material.id %}" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                    {% if material.status == 'active' %}
                                        <span class="badge bg-success status-badge">Aktywny</span>
                                    {% else %}
                                        <span class="badge bg-secondary status-badge">Nieaktywny</span>
                                    {% endif %}
                                    <span class="order-number">{{ forloop.counter }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-message">
                        <i class="fas fa-photo-video fa-3x mb-3"></i>
                        <h5>Brak materiałów reklamowych dla tego stoiska</h5>
                        <p>Dodaj materiały, aby rozpocząć konfigurację wyświetlania reklam.</p>
                    </div>
                {% endif %}
                
                <div class="drop-indicator">
                    <i class="fas fa-arrow-down fa-2x mb-2"></i>
                    <h5>Upuść tutaj, aby dodać do listy</h5>
                </div>
            </div>
            
            {% if materials %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Przeciągaj karty, aby zmienić kolejność wyświetlania materiałów reklamowych.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
<script>
    $(function() {
        // Inicjalizacja sortable
        $("#sortable").sortable({
            placeholder: "col-lg-4 col-md-6 mb-4 ui-sortable-placeholder",
            handle: ".material-card",
            start: function(e, ui) {
                ui.helper.addClass("ui-sortable-helper");
                $("#sortable-container").addClass("drop-active");
            },
            stop: function(e, ui) {
                ui.item.removeClass("ui-sortable-helper");
                $("#sortable-container").removeClass("drop-active");
                
                // Aktualizacja numerów kolejności
                updateOrderNumbers();
                
                // Zapisanie nowej kolejności
                saveOrder();
            }
        });
        
        // Funkcja aktualizująca numery kolejności
        function updateOrderNumbers() {
            $(".material-card .order-number").each(function(index) {
                $(this).text(index + 1);
            });
        }
        
        // Funkcja zapisująca kolejność na serwerze
        function saveOrder() {
            // Zbierz wszystkie ID w nowej kolejności
            var materialIds = [];
            $("#sortable .material-card").each(function() {
                materialIds.push($(this).closest("[data-id]").data("id"));
            });
            
            // Wysłanie żądania AJAX
            $.ajax({
                url: "{% url 'update-material-order' stand_id=stand.id %}",
                type: "POST",
                data: {
                    'materials[]': materialIds,
                    'csrfmiddlewaretoken': "{{ csrf_token }}"
                },
                success: function(response) {
                    if (response.status === 'success') {
                        // Sukces
                        showToast("Kolejność materiałów została zaktualizowana", "success");
                    } else {
                        // Błąd
                        showToast("Wystąpił błąd: " + response.message, "danger");
                    }
                },
                error: function(xhr) {
                    let errorMessage = "Wystąpił błąd podczas zapisywania kolejności.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage += " " + xhr.responseJSON.message;
                    }
                    showToast(errorMessage, "danger");
                }
            });
        }
        
        // Funkcja do wyświetlania powiadomień
        function showToast(message, type) {
            // Utwórz toast
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `);
            
            // Dodaj toast do kontenera
            if (!$("#toast-container").length) {
                $("body").append(`
                    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
                `);
            }
            $("#toast-container").append(toast);
            
            // Pokaż toast
            const bsToast = new bootstrap.Toast(toast[0], {
                delay: 3000
            });
            bsToast.show();
            
            // Usuń toast po ukryciu
            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    });
</script>
{% endblock %}